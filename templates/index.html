<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNLOCK</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÉ</text></svg>">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --bordeaux: #6d071a; --off-white: #fdfdfb; --text-dark: #2c2c2c; --glass: rgba(255, 255, 255, 0.95); }
        body { background: var(--off-white); color: var(--text-dark); font-family: 'Inter', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; background: var(--off-white); border-bottom: 1px solid #eee; z-index: 1001; position: relative; }
        .logo { font-weight: 800; font-size: 1.4rem; color: var(--bordeaux); letter-spacing: -1px; }
        
        /* MENU CONTROLS */
        .controls { display: flex; align-items: center; gap: 10px; transition: all 0.3s ease; }
        
        .burger-menu { display: none; background: none; border: none; cursor: pointer; padding: 5px; }
        .burger-icon { width: 24px; height: 24px; fill: var(--text-dark); }

        .switch-container { display: flex; background: #eee; padding: 4px; border-radius: 10px; gap: 4px; }
        .switch-btn { padding: 6px 14px; border-radius: 7px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.2s; border: none; color: #888; background: transparent; }
        .switch-btn.active { background: white; color: var(--bordeaux); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { padding: 8px 18px; border-radius: 8px; font-weight: 600; text-decoration: none; font-size: 0.85rem; cursor: pointer; border: none; }
        
        .btn-story { 
            background: white; color: #888; border: 1px solid #ddd;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .btn-story:hover { border-color: var(--bordeaux); color: var(--bordeaux); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .btn-logout { color: #888; border: 1px solid #ddd; background: white; }
        .btn-logout:hover { border-color: #aaa; color: #555; }
        
        /* Lien LinkedIn DANS le menu (cach√© par d√©faut sur PC) */
        .linkedin-menu-item { display: none; } 

        select { padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: white; font-weight: 600; color: var(--text-dark); outline: none; font-size: 0.8rem; cursor: pointer; }
        
        #map-wrapper { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .leaflet-tile { filter: brightness(0.92) contrast(0.95); }
        
        /* STATS OVERLAY */
        .stats-overlay { 
            position: absolute; top: 20px; left: 20px; z-index: 1000; 
            display: flex; flex-direction: column; gap: 12px; 
            max-height: calc(100vh - 40px); overflow-y: auto; scrollbar-width: none; 
            transition: all 0.3s ease;
        }
        .stats-overlay::-webkit-scrollbar { display: none; }
        
        .stat-card {
            background: var(--glass); backdrop-filter: blur(10px); padding: 15px 20px; border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.6); border-left: 4px solid var(--bordeaux);
        }
        .stat-label { font-size: 0.65rem; color: #777; text-transform: uppercase; font-weight: 700; }
        .stat-value { font-size: 1.3rem; font-weight: 800; color: var(--bordeaux); display: block; }
        .equivalence-text { font-size: 0.7rem; color: #666; margin-top: 5px; font-weight: 500; font-style: italic; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 5px; }

        #city-search { width: 100%; margin-top: 8px; padding: 8px 12px; font-size: 0.9rem; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; font-family: 'Inter', sans-serif; box-sizing: border-box; }
        #city-search:focus { outline: none; border-color: var(--bordeaux); box-shadow: 0 0 0 3px rgba(109, 7, 26, 0.1); }

        .city-table { width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 0.75rem; }
        .city-table tr { border-bottom: 1px solid rgba(0,0,0,0.05); transition: 0.2s; }
        .city-table tr:hover { background: rgba(0,0,0,0.02); }
        .city-table td { padding: 6px 0; vertical-align: middle; }
        .rank-col { width: 25px; color: #999; font-weight: 800; font-style: italic; }
        .city-name { font-weight: 600; color: var(--text-dark); }
        .city-stats { text-align: right; }
        
        .sort-header { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .sort-controls { display: flex; gap: 5px; }
        .sort-btn { border: 1px solid #ddd; background: transparent; border-radius: 4px; padding: 2px 6px; font-size: 0.6rem; font-weight: 700; color: #888; cursor: pointer; }
        .sort-btn.active { background: var(--bordeaux); color: white; border-color: var(--bordeaux); }

        .legend { 
            position: absolute; bottom: 80px; right: 20px; left: auto; z-index: 1000; 
            background: var(--glass); backdrop-filter: blur(10px); padding: 12px; 
            border-radius: 10px; display: none; flex-direction: column; gap: 8px; border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .legend-scale { height: 8px; width: 140px; border-radius: 4px; background: linear-gradient(to right, rgba(109, 7, 26, 0.2), rgba(109, 7, 26, 1)); }
        .legend-labels { display: flex; justify-content: space-between; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; color: #555; }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: var(--off-white); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader-content { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .loader-text { color: var(--bordeaux); font-weight: 700; margin-bottom: 20px; letter-spacing: 2px; text-transform: uppercase; }
        .progress-bar { width: 220px; height: 4px; background: rgba(109, 7, 26, 0.1); border-radius: 10px; overflow: hidden; position: relative; }
        .progress-fill { position: absolute; width: 40%; height: 100%; background: var(--bordeaux); animation: loading 1.8s infinite ease-in-out; }
        @keyframes loading { 0% { left: -40%; } 100% { left: 100%; } }
        .loader-signature { position: absolute; bottom: 30px; display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--bordeaux); opacity: 0.6; text-decoration: none; font-weight: 600; transition: opacity 0.3s, transform 0.3s; }
        .loader-signature:hover { opacity: 1; transform: translateY(-2px); }

        /* SIGNATURE FLOTTANTE (PC) */
        .dev-badge {
            position: fixed; bottom: 20px; right: 20px; left: auto; z-index: 2000;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); padding: 8px 16px; border-radius: 10px; 
            text-decoration: none; color: #555; font-size: 0.75rem; font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;
        }
        .dev-badge:hover { transform: translateY(-2px); color: var(--bordeaux); box-shadow: 0 6px 20px rgba(109, 7, 26, 0.15); }
        .linkedin-icon { width: 14px; height: 14px; fill: currentColor; }

        /* ========================================= */
        /* ---        MEDIA QUERIES (MOBILE)     --- */
        /* ========================================= */
        @media (max-width: 1200px) {
            header { padding: 15px 20px; }
            .logo { font-size: 1.3rem; }
            
            /* Burger visible */
            .burger-menu { display: block; }
            
            /* Menu d√©roulant (Am√©lior√©) */
            .controls {
                display: block; /* N√©cessaire pour l'animation height */
                position: absolute;
                top: 60px; left: 0; right: 0;
                background: var(--off-white);
                
                /* Animation de d√©roulement */
                max-height: 0;
                overflow: hidden;
                padding: 0 20px;
                border-bottom: none;
                box-shadow: none;
                
                transition: max-height 0.4s ease-in-out, padding 0.4s ease, box-shadow 0.4s ease;
                flex-direction: column;
                align-items: stretch; 
                gap: 15px;
            }
            
            /* √âtat Ouvert */
            .controls.mobile-visible { 
                max-height: 500px;
                padding: 20px;
                border-bottom: 1px solid #ddd;
                box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            }

            /* Switch Tabs (Plus jolis sur mobile) */
            .switch-container { 
                justify-content: center; 
                background: #e8e8e8;
                padding: 5px;
                border-radius: 12px;
                margin-bottom: 5px;
            }
            .switch-btn { 
                flex: 1; /* Prend toute la largeur */
                text-align: center;
                padding: 10px;
                border-radius: 8px;
                font-size: 0.85rem;
            }

            .btn-story, .btn-logout, .btn { 
                justify-content: center; padding: 12px; 
                width: 100%; box-sizing: border-box;
            }
            
            select { padding: 12px; width: 100%; box-sizing: border-box; }

            /* Stats en bas */
            .stats-overlay {
                top: auto; bottom: 0; left: 10px; right: 10px;
                max-height: 35vh; z-index: 1000;
            }
            .stat-card { padding: 10px 15px; }
            
            /* CACHER LE BADGE FLOTTANT SUR MOBILE */
            .dev-badge { display: none; }
            
            /* AFFICHER LE LIEN DANS LE MENU */
            .linkedin-menu-item {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                margin-top: 10px;
                padding-top: 15px;
                border-top: 1px solid #eee;
                color: var(--bordeaux);
                text-decoration: none;
                font-weight: 700;
                font-size: 0.85rem;
            }
            
            .legend { bottom: 42vh; right: 10px; padding: 8px; }
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="loader-content">
        <div class="loader-text">Analyse des traces GPS...</div>
        <div class="progress-bar"><div class="progress-fill"></div></div>
    </div>
    <a href="https://www.linkedin.com/in/th%C3%A9ophile-s%C3%A9n%C3%A9chal-5119181a9/" target="_blank" class="loader-signature">
        <svg class="linkedin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
        <span>Th√©ophile S√©n√©chal</span>
    </a>
</div>

<header>
    <div class="logo">UNLOCK</div>
    
    <button class="burger-menu" onclick="toggleMenu()">
        <svg class="burger-icon" viewBox="0 0 24 24">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
    </button>

    <div class="controls" id="mobile-controls">
        <div class="switch-container">
            <button class="switch-btn active" onclick="setMode('route')" id="btn-route">TRAC√âS</button>
            <button class="switch-btn" onclick="setMode('grid')" id="btn-grid">BLOCS</button>
        </div>
        
        <select id="sport-select" onchange="updateDashboard()">
            <option value="all">TOUS SPORTS</option>
        </select>

        <select id="grid-size-select" onchange="updateDashboard()" style="display:none;">
            <option value="100">100M / 100M</option>
            <option value="250">250M / 250M</option>
            <option value="500">500M / 500M</option>
            <option value="1000">1KM / 1KM</option>
        </select>
        <select id="year-select" onchange="updateDashboard()"><option value="all">HISTORIQUE</option></select>
        
        <a href="/timelapse" class="btn btn-story" style="text-decoration: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            TIMELAPSE
        </a>

        <a href="/story" class="btn btn-story" style="text-decoration: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
            </svg>
            STORY
        </a>

        <a href="/stats" class="btn btn-story" style="text-decoration: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M18 20V10"></path><path d="M12 20V4"></path><path d="M6 20v-6"></path>
            </svg>
            STATS
        </a>

        <a href="/logout" class="btn btn-logout" id="logout-btn">D√âCONNEXION</a>

        <a href="https://www.linkedin.com/in/th%C3%A9ophile-s%C3%A9n%C3%A9chal-5119181a9/" target="_blank" class="linkedin-menu-item">
            <svg class="linkedin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            Th√©ophile S√©n√©chal
        </a>
    </div>
</header>

<div id="map-wrapper">
    <div class="stats-overlay">
        <div class="stat-card">
            <span class="stat-label">Activit√©s</span>
            <span id="count" class="stat-value">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Distance</span>
            <span id="distance" class="stat-value">0.0</span> <small style="font-weight: 700;">KM</small>
        </div>
        <div class="stat-card" id="card-cells" style="display: none;">
            <span class="stat-label">Zones Explor√©es</span>
            <span id="cells" class="stat-value">0</span>
            <div id="equivalence-text" class="equivalence-text">Soit env. 0 terrains de football</div>
        </div>
        
        <div class="stat-card" id="card-muni" style="display: none; min-width: 260px;">
            <span class="stat-label">Villes Explor√©es</span>
            
            <input type="text" id="city-search" list="city-suggestions" placeholder="Chercher une commune..." onchange="onCitySearch()">
            <datalist id="city-suggestions"></datalist>

            <div id="city-info-box" style="margin-top: 15px; display: none;">
                <span id="muni-name" class="stat-value" style="font-size: 1.1rem; margin-top: 2px;">-</span>
                <span id="muni-percent" style="font-size: 1.4rem; color: var(--bordeaux); font-weight: 800; display: block;">-</span>
                <div id="muni-details" class="equivalence-text"></div>
            </div>

            <div class="sort-header">
                <span class="stat-label">Top 5</span>
                <div class="sort-controls">
                    <button id="sort-blocks" class="sort-btn active" onclick="setSortMode('blocks')">BLOCS</button>
                    <button id="sort-percent" class="sort-btn" onclick="setSortMode('percent')">%</button>
                </div>
            </div>
            <table class="city-table" id="top-cities-list"></table>
        </div>
    </div>

    <div id="grid-legend" class="legend">
        <span class="stat-label" style="margin-bottom: 2px;">Intensit√© de passage</span>
        <div class="legend-scale"></div>
        <div class="legend-labels"><span>Rare</span><span>Fr√©quent</span></div>
    </div>

    <div id="map"></div>

    <a href="https://www.linkedin.com/in/th%C3%A9ophile-s%C3%A9n%C3%A9chal-5119181a9/" target="_blank" class="dev-badge">
        <svg class="linkedin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
        <span>D√©velopp√© par <strong>Th√©ophile S√©n√©chal</strong></span>
    </a>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    function toggleMenu() {
        const controls = document.getElementById('mobile-controls');
        controls.classList.toggle('mobile-visible');
    }

    const SPORT_TRANSLATIONS = {
        'Run': 'Course √† pied',
        'Ride': 'V√©lo',
        'Swim': 'Natation',
        'Hike': 'Randonn√©e',
        'Walk': 'Marche',
        'AlpineSki': 'Ski Alpin',
        'BackcountrySki': 'Ski de Rando',
        'WeightTraining': 'Musculation',
        'Workout': 'Entra√Ænement',
        'VirtualRide': 'V√©lo Virtuel',
        'VirtualRun': 'Course Virtuelle',
        'GravelRide': 'Gravel',
        'TrailRun': 'Trail',
        'E-BikeRide': 'V√©lo √âlectrique',
        'Velomobile': 'V√©lomobile',
        'NordicSki': 'Ski de Fond',
        'Snowshoe': 'Raquettes'
    };

    const map = L.map('map', { zoomControl: false }).setView([47.65, -2.75], 13);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    const traceLayer = L.layerGroup().addTo(map);
    const muniLayer = L.layerGroup().addTo(map);
    
    let currentData = null;
    let currentMode = 'route';
    let currentSort = 'blocks'; 
    let currentSelectedCityName = null;

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('btn-route').classList.toggle('active', mode === 'route');
        document.getElementById('btn-grid').classList.toggle('active', mode === 'grid');
        document.getElementById('grid-size-select').style.display = mode === 'grid' ? 'inline-block' : 'none';
        document.getElementById('card-cells').style.display = mode === 'grid' ? 'block' : 'none';
        document.getElementById('grid-legend').style.display = mode === 'grid' ? 'flex' : 'none';
        document.getElementById('card-muni').style.display = mode === 'grid' ? 'block' : 'none';
        renderData(); 
        
        if(window.innerWidth < 1200) {
             document.getElementById('mobile-controls').classList.remove('mobile-visible');
        }
    }

    function setSortMode(mode) {
        currentSort = mode;
        document.getElementById('sort-blocks').classList.toggle('active', mode === 'blocks');
        document.getElementById('sort-percent').classList.toggle('active', mode === 'percent');
        renderLeaderboard();
    }

    async function updateDashboard() {
        const year = document.getElementById('year-select').value;
        const gridSize = document.getElementById('grid-size-select').value;
        const sportType = document.getElementById('sport-select').value;
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';

        try {
            const response = await fetch(`/api/activities?year=${year}&grid_size=${gridSize}&sport_type=${sportType}`);
            if (!response.ok) throw new Error();
            currentData = await response.json();

            document.getElementById('logout-btn').style.display = 'inline-block';

            const yearSelect = document.getElementById('year-select');
            if (yearSelect.options.length === 1 && currentData.available_years.length > 0) {
                currentData.available_years.forEach(y => {
                    let opt = document.createElement('option');
                    opt.value = y; opt.textContent = y;
                    yearSelect.appendChild(opt);
                });
            }

            const sportSelect = document.getElementById('sport-select');
            while (sportSelect.options.length > 1) { sportSelect.remove(1); }
            if (currentData.available_sports) {
                for (const [code, name] of Object.entries(currentData.available_sports)) {
                    let opt = document.createElement('option');
                    opt.value = code;
                    const translatedName = SPORT_TRANSLATIONS[code] ? SPORT_TRANSLATIONS[code].toUpperCase() : name.toUpperCase();
                    opt.textContent = translatedName;
                    
                    if (code === sportType) opt.selected = true;
                    sportSelect.appendChild(opt);
                }
            }

            document.getElementById('count').textContent = currentData.stats.activity_count;
            document.getElementById('distance').textContent = currentData.stats.total_distance.toFixed(1);
            const cells = currentData.stats.cells_conquered;
            document.getElementById('cells').textContent = cells;
            const m = parseInt(gridSize);
            const footballFields = Math.round((cells * m * m) / 7140);
            document.getElementById('equivalence-text').textContent = `Soit env. ${footballFields.toLocaleString()} terrains de football`;

            const dataList = document.getElementById('city-suggestions');
            dataList.innerHTML = '';
            if (currentData.top_municipalities) {
                const sortedAlpha = [...currentData.top_municipalities].sort((a, b) => a.name.localeCompare(b.name));
                sortedAlpha.forEach(city => {
                    let option = document.createElement('option');
                    option.value = city.name;
                    dataList.appendChild(option);
                });
            }
            
            if (!currentSelectedCityName && currentData.top_municipalities.length > 0) {
                currentSelectedCityName = currentData.top_municipalities[0].name;
            }

            renderData();
        } catch (err) { console.error(err); } finally {
            setTimeout(() => { loader.style.display = 'none'; }, 600);
        }
    }

    function onCitySearch() {
        const inputVal = document.getElementById('city-search').value;
        if (!currentData || !currentData.top_municipalities) return;
        const city = currentData.top_municipalities.find(c => c.name.toLowerCase() === inputVal.toLowerCase());
        if (city) {
            currentSelectedCityName = city.name;
            displayActiveCity(city);
        }
    }

    function displayActiveCity(city) {
        if (!city) return;
        const infoBox = document.getElementById('city-info-box');
        infoBox.style.display = 'block';
        document.getElementById('muni-name').textContent = city.name;
        document.getElementById('muni-percent').textContent = `${city.stats.percent}% d√©couverts`;
        document.getElementById('muni-details').textContent = `${city.stats.blocks} blocs explor√©s`;

        muniLayer.clearLayers();
        if (city.outline) {
            const polygon = L.polygon(city.outline, {
                color: 'var(--bordeaux)',
                weight: 3,
                fillOpacity: 0.1,
                interactive: false
            }).addTo(muniLayer);
            map.fitBounds(polygon.getBounds(), { padding: [50, 50] });
        }
    }

    function renderLeaderboard() {
        if (!currentData || !currentData.top_municipalities) return;
        const tableBody = document.getElementById('top-cities-list');
        tableBody.innerHTML = '';
        let sortedCities = [...currentData.top_municipalities];

        if (currentSort === 'blocks') { sortedCities.sort((a, b) => b.stats.blocks - a.stats.blocks); } 
        else { sortedCities.sort((a, b) => b.stats.percent - a.stats.percent); }

        sortedCities.slice(0, 5).forEach((city, index) => {
            const row = document.createElement('tr');
            const activeStyle = 'color: var(--bordeaux); font-weight: 800; font-size: 0.9rem;';
            const passiveStyle = 'color: #999; font-weight: 400; font-size: 0.75rem;';
            let mainContent = '';
            
            if (currentSort === 'percent') {
                mainContent = `<span style="${activeStyle}">${city.stats.percent}%</span><span style="display:block; margin-top:2px; ${passiveStyle}">${city.stats.blocks} blocs</span>`;
            } else {
                mainContent = `<span style="${activeStyle}">${city.stats.blocks} blocs</span><span style="display:block; margin-top:2px; ${passiveStyle}">${city.stats.percent}%</span>`;
            }

            row.innerHTML = `<td class="rank-col">#${index + 1}</td><td class="city-name">${city.name}</td><td class="city-stats">${mainContent}</td>`;
            row.style.cursor = 'pointer';
            row.onclick = () => {
                currentSelectedCityName = city.name;
                displayActiveCity(city);
                document.getElementById('city-search').value = city.name;
            };
            tableBody.appendChild(row);
        });
    }

    function renderData() {
        if (!currentData) return;
        traceLayer.clearLayers();
        muniLayer.clearLayers();
        const size = currentData.grid_size_used;

        if (currentMode === 'grid') {
            if (currentSelectedCityName) {
                const city = currentData.top_municipalities.find(c => c.name === currentSelectedCityName);
                if (city) displayActiveCity(city);
            }
            renderLeaderboard();

            if (currentData.grid_cells) {
                const counts = currentData.grid_cells.map(c => c[2]);
                const maxCount = Math.max(...counts);
                
                currentData.grid_cells.forEach(cell => {
                    const [lat, lon, count, firstSeen, lastSeen] = cell;

                    // Formule d'intensit√© "Ancienne/Meilleure"
                    const intensity = 0.2 + (Math.sqrt(count / maxCount) * 0.6);
                    const bounds = [[lat - size/2, lon - size/2], [lat + size/2, lon + size/2]];
                    
                    const rect = L.rectangle(bounds, { 
                        color: "var(--bordeaux)", 
                        weight: 0, // Pas de bordure
                        fillOpacity: intensity 
                    }).addTo(traceLayer);

                    const [year, month] = lastSeen.split('-');
                    const formattedDate = `${month}/${year}`;

                    rect.bindTooltip(
                        `<div style="text-align: center; font-family: 'Inter', sans-serif;">
                            <div style="font-size: 1rem; font-weight: 800; color: var(--bordeaux);">${count} <span style="font-size:0.7rem; font-weight:500; color:#666;">PASSAGE${count > 1 ? 'S' : ''}</span></div>
                            <div style="font-size: 0.7rem; color: #888; margin-top:2px; border-top:1px solid #eee; padding-top:2px;">
                                Dernier : <strong>${formattedDate}</strong>
                            </div>
                        </div>`,
                        {
                            sticky: true,
                            direction: 'top',
                            opacity: 0.95
                        }
                    );
                });
            }
        } else {
            currentData.coords.forEach(points => {
                L.polyline(points, { color: 'var(--bordeaux)', weight: 3, opacity: 0.6 }).addTo(traceLayer);
            });
            const group = new L.featureGroup([traceLayer]);
            if (group.getLayers().length > 0) map.fitBounds(group.getBounds());
        }
    }

    updateDashboard();
</script>
</body>
</html>